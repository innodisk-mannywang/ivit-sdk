# iVIT-SDK Docker Compose Configuration
#
# 使用方式：
#
# 1. 建置並啟動驗證環境（CPU）：
#    docker compose -f docker/docker-compose.yml up verify
#
# 2. 進入互動模式：
#    docker compose -f docker/docker-compose.yml run --rm dev bash
#
# 3. 建置並啟動驗證環境（GPU）：
#    docker compose -f docker/docker-compose.yml up verify-gpu
#
# 4. 清理：
#    docker compose -f docker/docker-compose.yml down

version: '3.8'

services:
  # ============================================================================
  # 開發環境（互動模式）
  # ============================================================================
  dev:
    build:
      context: ..
      dockerfile: docker/Dockerfile.verify
    image: ivit-sdk-dev:latest
    container_name: ivit-dev
    volumes:
      - ..:/workspace/ivit-sdk
      - ivit-cache:/root/.cache
    working_dir: /workspace/ivit-sdk
    stdin_open: true
    tty: true
    environment:
      - PYTHONPATH=/workspace/ivit-sdk/python
    command: bash

  # ============================================================================
  # 自動驗證（CPU）
  # ============================================================================
  verify:
    build:
      context: ..
      dockerfile: docker/Dockerfile.verify
    image: ivit-sdk-verify:latest
    container_name: ivit-verify
    volumes:
      - ..:/workspace/ivit-sdk:ro
      - verify-output:/tmp/ivit-output
    working_dir: /workspace/ivit-sdk
    command: verify-sdk.sh

  # ============================================================================
  # 自動驗證（GPU）- 需要 NVIDIA Docker
  # ============================================================================
  verify-gpu:
    build:
      context: ..
      dockerfile: docker/Dockerfile.full
    image: ivit-sdk-verify-gpu:latest
    container_name: ivit-verify-gpu
    volumes:
      - ..:/workspace/ivit-sdk:ro
      - verify-output:/tmp/ivit-output
    working_dir: /workspace/ivit-sdk
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    command: verify-sdk.sh

  # ============================================================================
  # Python 專用驗證
  # ============================================================================
  verify-python:
    build:
      context: ..
      dockerfile: docker/Dockerfile.verify
    image: ivit-sdk-verify:latest
    container_name: ivit-verify-python
    volumes:
      - ..:/workspace/ivit-sdk:ro
    working_dir: /workspace/ivit-sdk
    command: verify-sdk.sh --python-only

  # ============================================================================
  # C++ 專用驗證
  # ============================================================================
  verify-cpp:
    build:
      context: ..
      dockerfile: docker/Dockerfile.verify
    image: ivit-sdk-verify:latest
    container_name: ivit-verify-cpp
    volumes:
      - ..:/workspace/ivit-sdk:ro
    working_dir: /workspace/ivit-sdk
    command: verify-sdk.sh --cpp-only

volumes:
  ivit-cache:
  verify-output:
